{"file_path": "Source/BasketBallGame/BasketballHoop.cpp", "file_id": "Source_BasketBallGame_BasketballHoop_cpp", "asset_path": "", "doc_id": "qq-4989c1f1-cb84-4e58-9d4e-e34665d24e54", "referencers": [], "dependencies": [], "content": "\ufeff// Copyright Epic Games, Inc. All Rights Reserved.\n\n#include \"BasketballHoop.h\"\n#include \"Basketball.h\"\n#include \"BasketBallGameGameMode.h\"\n#include \"BasketBallGameState.h\"\n#include \"Components/StaticMeshComponent.h\"\n#include \"PhysicsEngine/BodySetup.h\"\n#include \"Components/BoxComponent.h\"\n#include \"Components/SceneComponent.h\"\n#include \"Engine/World.h\"\n\nABasketBallHoop::ABasketBallHoop()\n{\n\t// Enable ticking if needed for animations later\n\tPrimaryActorTick.bCanEverTick = false;\n\n\t// Create root component (invisible positioning anchor)\n\tHoopRoot = CreateDefaultSubobject<USceneComponent>(TEXT(\"HoopRoot\"));\n\tRootComponent = HoopRoot;\n\n\t// Create backboard mesh\n\tBackboard = CreateDefaultSubobject<UStaticMeshComponent>(TEXT(\"Backboard\"));\n\tBackboard->SetupAttachment(HoopRoot);\n\tBackboard->SetCollisionEnabled(ECollisionEnabled::QueryAndPhysics);\n\tBackboard->SetCollisionResponseToAllChannels(ECR_Block);\n\tBackboard->SetRelativeLocation(FVector(0.0f, 0.0f, 0.0f)); // At root (pivot is at backboard center)\n\n\t// Create rim mesh (attached to backboard)\n\tRim = CreateDefaultSubobject<UStaticMeshComponent>(TEXT(\"Rim\"));\n\tRim->SetupAttachment(Backboard); // Attached to backboard, not root\n\tRim->SetCollisionEnabled(ECollisionEnabled::QueryAndPhysics);\n\tRim->SetCollisionResponseToAllChannels(ECR_Block);\n\tRim->SetRelativeLocation(FVector(15.0f, 0.0f, -45.0f)); // Forward from backboard, below center\n\n\t// Create top trigger (ball enters hoop) - attached to rim\n\tTopTrigger = CreateDefaultSubobject<UBoxComponent>(TEXT(\"TopTrigger\"));\n\tTopTrigger->SetupAttachment(Rim); // Attached to rim\n\tTopTrigger->SetBoxExtent(FVector(25.0f, 25.0f, 5.0f)); // 50cm diameter, 10cm height\n\tTopTrigger->SetRelativeLocation(FVector(0.0f, 0.0f, -5.0f)); // Just below rim center\n\tTopTrigger->SetCollisionEnabled(ECollisionEnabled::QueryOnly);\n\tTopTrigger->SetCollisionResponseToAllChannels(ECR_Ignore);\n\tTopTrigger->SetCollisionResponseToChannel(ECC_PhysicsBody, ECR_Overlap);\n\tTopTrigger->SetGenerateOverlapEvents(true);\n\n\t// Create bottom trigger (ball exits hoop - scores!)\n\tBottomTrigger = CreateDefaultSubobject<UBoxComponent>(TEXT(\"BottomTrigger\"));\n\tBottomTrigger->SetupAttachment(Rim); // Attached to rim\n\tBottomTrigger->SetBoxExtent(FVector(25.0f, 25.0f, 5.0f));\n\tBottomTrigger->SetRelativeLocation(FVector(0.0f, 0.0f, -45.0f)); // 40cm below top trigger (net length)\n\tBottomTrigger->SetCollisionEnabled(ECollisionEnabled::QueryOnly);\n\tBottomTrigger->SetCollisionResponseToAllChannels(ECR_Ignore);\n\tBottomTrigger->SetCollisionResponseToChannel(ECC_PhysicsBody, ECR_Overlap);\n\tBottomTrigger->SetGenerateOverlapEvents(true);\n\n\t// Default values\n\tPointValue = 2; // Standard 2-point shot\n\tHoopHeight = 305.0f; // 10 feet / 305cm\n\tCachedGameMode = nullptr;\n\t\n}\n\nvoid ABasketBallHoop::BeginPlay()\n{\n\tSuper::BeginPlay();\n\n\t// Use the actual mesh triangles for collision so the ball can pass through the rim opening\n\tif (Rim && Rim->GetStaticMesh())\n\t{\n\t\tUBodySetup* RimBodySetup = Rim->GetStaticMesh()->GetBodySetup();\n\t\tif (RimBodySetup)\n\t\t{\n\t\t\tRimBodySetup->CollisionTraceFlag = CTF_UseComplexAsSimple;\n\t\t\tRim->RecreatePhysicsState();\n\t\t}\n\t}\n\n\t// Bind overlap events\n\tTopTrigger->OnComponentBeginOverlap.AddDynamic(this, &ABasketBallHoop::OnTopTriggerBeginOverlap);\n\tBottomTrigger->OnComponentBeginOverlap.AddDynamic(this, &ABasketBallHoop::OnBottomTriggerBeginOverlap);\n\n\t// Cache GameMode reference with validation and retry logic\n\tif (UWorld* World = GetWorld())\n\t{\n\t\tCachedGameMode = World->GetAuthGameMode<ABasketBallGameGameMode>();\n\t\t\n\t\tif (!CachedGameMode)\n\t\t{\n\t\t\tUE_LOG(LogTemp, Warning, TEXT(\"BasketballHoop: GameMode not found at BeginPlay - scheduling retry\"));\n\t\t\t\n\t\t\t// Schedule retry after 0.1 seconds\n\t\t\tFTimerHandle RetryHandle;\n\t\t\tWorld->GetTimerManager().SetTimer(RetryHandle, [this]()\n\t\t\t{\n\t\t\t\tif (UWorld* RetryWorld = GetWorld())\n\t\t\t\t{\n\t\t\t\t\tCachedGameMode = RetryWorld->GetAuthGameMode<ABasketBallGameGameMode>();\n\t\t\t\t\tif (CachedGameMode)\n\t\t\t\t\t{\n\t\t\t\t\t\tUE_LOG(LogTemp, Log, TEXT(\"BasketballHoop: GameMode cached successfully on retry\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}, 0.1f, false);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tUE_LOG(LogTemp, Log, TEXT(\"BasketballHoop: GameMode cached successfully at BeginPlay\"));\n\t\t}\n\t}\n\t\n\t// ======== PHYSICS VALIDATION LOGGING ========\n\t// Verify trigger collision settings are correct to prevent double-scoring bugs\n\tif (TopTrigger && BottomTrigger)\n\t{\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"[BasketballHoop Physics Validation] %s\"), *GetName());\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"  TopTrigger Collision Enabled: %d (Expected: 1=QueryOnly)\"), static_cast<int32>(TopTrigger->GetCollisionEnabled()));\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"  TopTrigger Generate Overlap Events: %d\"), TopTrigger->GetGenerateOverlapEvents());\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"  BottomTrigger Collision Enabled: %d (Expected: 1=QueryOnly)\"), static_cast<int32>(BottomTrigger->GetCollisionEnabled()));\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"  BottomTrigger Generate Overlap Events: %d\"), BottomTrigger->GetGenerateOverlapEvents());\n\t}\n\t// ========================================\n\tUE_LOG(LogTemp, Log, TEXT(\"Basketball Hoop initialized at height: %.0f cm\"), HoopHeight);\n}\n\nvoid ABasketBallHoop::OnTopTriggerBeginOverlap(UPrimitiveComponent* OverlappedComponent, AActor* OtherActor,\n\tUPrimitiveComponent* OtherComp, int32 OtherBodyIndex, bool bFromSweep, const FHitResult& SweepResult)\n{\n\t// Check if it's a basketball\n\tABasketBall* Ball = Cast<ABasketBall>(OtherActor);\n\tif (!Ball)\n\t{\n\t\treturn;\n\t}\n\n\t// Check if ball is moving downward (entering hoop from above)\n\tFVector BallVelocity = Ball->BallMesh->GetPhysicsLinearVelocity();\n\tif (BallVelocity.Z > 0.0f)\n\t{\n\t\t// Ball is moving upward, not a valid shot\n\t\treturn;\n\t}\n\n\t// Track this ball as having entered the top trigger\n\tBallsInTopTrigger.Add(Ball);\n\n\tUE_LOG(LogTemp, Log, TEXT(\"Ball entered hoop (top trigger): %s\"), *Ball->GetName());\n}\n\nvoid ABasketBallHoop::OnBottomTriggerBeginOverlap(\n\tUPrimitiveComponent* OverlappedComponent,\n\tAActor* OtherActor,\n\tUPrimitiveComponent* OtherComp,\n\tint32 OtherBodyIndex,\n\tbool bFromSweep,\n\tconst FHitResult& SweepResult)\n{\n\tABasketBall* Ball = Cast<ABasketBall>(OtherActor);\n\tif (!Ball)\n\t{\n\t\treturn;\n\t}\n\n\t// Must have been intentionally shot\n\tif (!Ball->bWasShot)\n\t{\n\t\treturn;\n\t}\n\n\t// Prevent double scoring\n\tif (Ball->bHasScoredThisShot)\n\t{\n\t\treturn;\n\t}\n\n\t// Must have passed top trigger first\n\tif (!BallsInTopTrigger.Contains(Ball))\n\t{\n\t\treturn;\n\t}\n\n\t// Valid score\n\tBall->bHasScoredThisShot = true;\t\n\tBallsInTopTrigger.Remove(Ball);\n\n\t// \ud83d\udd25 Disable overlap ONLY for this ball mesh\n\tBall->BallMesh->SetGenerateOverlapEvents(false);\n\n\tRegisterScoreWithGameMode(Ball);\n\tUE_LOG(LogTemp, Warning, TEXT(\"VALID SCORE REGISTERED\"));\n}\n\nvoid ABasketBallHoop::RegisterScoreWithGameMode(ABasketBall* Ball)\n{\n\tif (!Ball)\n\t{\n\t\treturn;\n\t}\n\n\tif (!CachedGameMode)\n\t{\n\t\tif (UWorld* World = GetWorld())\n\t\t{\n\t\t\tCachedGameMode = World->GetAuthGameMode<ABasketBallGameGameMode>();\n\t\t}\n\t}\n\n\tif (!CachedGameMode)\n\t{\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"Hoop: GameMode not found\"));\n\t\treturn;\n\t}\n\n\tCachedGameMode->RegisterShotSuccess(PointValue);\n\n\tUE_LOG(LogTemp, Warning, TEXT(\"Hoop: Shot SUCCESS | +%d points\"), PointValue);\n\n\tOnShotMade();\n}\n\n\n"}