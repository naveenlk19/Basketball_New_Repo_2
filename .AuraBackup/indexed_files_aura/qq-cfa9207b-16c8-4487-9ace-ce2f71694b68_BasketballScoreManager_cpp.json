{"file_path": "Source/BasketBallGame/BasketballScoreManager.cpp", "file_id": "Source_BasketBallGame_BasketballScoreManager_cpp", "asset_path": "", "doc_id": "qq-cfa9207b-16c8-4487-9ace-ce2f71694b68", "referencers": [], "dependencies": [], "content": "// Copyright Epic Games, Inc. All Rights Reserved.\n\n#include \"BasketballScoreManager.h\"\n#include \"BasketballHoop.h\"\n#include \"Kismet/GameplayStatics.h\"\n#include \"Engine/World.h\"\n\nUBasketballScoreManager::UBasketballScoreManager()\n{\n\tPrimaryComponentTick.bCanEverTick = true;\n\tPrimaryComponentTick.bStartWithTickEnabled = true;\n\n\t// Score defaults\n\tTotalScore = 0;\n\tTotalMakes = 0;\n\tTotalAttempts = 0;\n\tCurrentStreak = 0;\n\tBestStreak = 0;\n\n\t// Timer defaults\n\tRoundDuration = 60.0f; // 60 second rounds\n\tRemainingTime = 0.0f;\n\tbGameActive = false;\n\tLastBroadcastedTime = 0.0f;\n}\n\nvoid UBasketballScoreManager::BeginPlay()\n{\n\tSuper::BeginPlay();\n\n\t// Find all hoops in level and bind to their score events\n\tBindToAllHoops();\n\n\tUE_LOG(LogTemp, Log, TEXT(\"BasketballScoreManager: Bound to %d hoops\"), RegisteredHoops.Num());\n}\n\nvoid UBasketballScoreManager::TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction)\n{\n\tSuper::TickComponent(DeltaTime, TickType, ThisTickFunction);\n\n\tif (!bGameActive || RoundDuration <= 0.0f)\n\t{\n\t\treturn;\n\t}\n\n\t// Update timer\n\tRemainingTime -= DeltaTime;\n\n\t// Broadcast time updates every second\n\tfloat CurrentSecond = FMath::FloorToFloat(RemainingTime);\n\tif (CurrentSecond != LastBroadcastedTime)\n\t{\n\t\tLastBroadcastedTime = CurrentSecond;\n\t\tOnTimerUpdated.Broadcast(FMath::Max(0.0f, RemainingTime));\n\t}\n\n\t// Check if time is up\n\tif (RemainingTime <= 0.0f)\n\t{\n\t\tRemainingTime = 0.0f;\n\t\tEndGame();\n\t}\n}\n\nvoid UBasketballScoreManager::BindToAllHoops()\n{\n\tUWorld* World = GetWorld();\n\tif (!World)\n\t{\n\t\treturn;\n\t}\n\n\tTArray<AActor*> FoundHoops;\n\tUGameplayStatics::GetAllActorsOfClass(World, ABasketballHoop::StaticClass(), FoundHoops);\n\n\tfor (AActor* Actor : FoundHoops)\n\t{\n\t\tABasketballHoop* Hoop = Cast<ABasketballHoop>(Actor);\n\t\tif (Hoop)\n\t\t{\n\t\t\tHoop->OnScored.AddDynamic(this, &UBasketballScoreManager::OnHoopScored);\n\t\t\tRegisteredHoops.Add(Hoop);\n\n\t\t\tUE_LOG(LogTemp, Log, TEXT(\"BasketballScoreManager: Bound to hoop: %s\"), *Hoop->GetName());\n\t\t}\n\t}\n}\n\nvoid UBasketballScoreManager::OnHoopScored(int32 Points)\n{\n\t// Update score\n\tTotalScore += Points;\n\tTotalMakes++;\n\tTotalAttempts++;\n\n\t// Update streak\n\tCurrentStreak++;\n\tif (CurrentStreak > BestStreak)\n\t{\n\t\tBestStreak = CurrentStreak;\n\t}\n\n\t// Broadcast score change\n\tOnScoreChanged.Broadcast(TotalScore, TotalMakes, TotalAttempts);\n\n\tUE_LOG(LogTemp, Warning, TEXT(\"SCORE! +%d | Total: %d | Makes: %d/%d (%.1f%%) | Streak: %d (Best: %d)\"),\n\t\tPoints, TotalScore, TotalMakes, TotalAttempts, GetShootingPercentage(), CurrentStreak, BestStreak);\n}\n\nfloat UBasketballScoreManager::GetShootingPercentage() const\n{\n\tif (TotalAttempts == 0)\n\t{\n\t\treturn 0.0f;\n\t}\n\treturn (float)TotalMakes / (float)TotalAttempts * 100.0f;\n}\n\nvoid UBasketballScoreManager::StartGame()\n{\n\tResetScore();\n\tRemainingTime = RoundDuration;\n\tbGameActive = true;\n\tLastBroadcastedTime = FMath::FloorToFloat(RoundDuration);\n\n\tOnGameStarted.Broadcast();\n\tOnTimerUpdated.Broadcast(RemainingTime);\n\n\tUE_LOG(LogTemp, Warning, TEXT(\"GAME STARTED! Duration: %.0f seconds\"), RoundDuration);\n}\n\nvoid UBasketballScoreManager::EndGame()\n{\n\tbGameActive = false;\n\n\tOnGameEnded.Broadcast(TotalScore);\n\n\tUE_LOG(LogTemp, Warning, TEXT(\"GAME OVER! Final Score: %d | Makes: %d/%d (%.1f%%) | Best Streak: %d\"),\n\t\tTotalScore, TotalMakes, TotalAttempts, GetShootingPercentage(), BestStreak);\n}\n\nvoid UBasketballScoreManager::ResetScore()\n{\n\tTotalScore = 0;\n\tTotalMakes = 0;\n\tTotalAttempts = 0;\n\tCurrentStreak = 0;\n\tBestStreak = 0;\n\n\tOnScoreChanged.Broadcast(0, 0, 0);\n}\n\nvoid UBasketballScoreManager::RegisterAttempt()\n{\n\tTotalAttempts++;\n\tCurrentStreak = 0; // Reset streak on miss\n\n\tOnScoreChanged.Broadcast(TotalScore, TotalMakes, TotalAttempts);\n\n\tUE_LOG(LogTemp, Log, TEXT(\"Shot missed. Makes: %d/%d (%.1f%%)\"),\n\t\tTotalMakes, TotalAttempts, GetShootingPercentage());\n}\n"}