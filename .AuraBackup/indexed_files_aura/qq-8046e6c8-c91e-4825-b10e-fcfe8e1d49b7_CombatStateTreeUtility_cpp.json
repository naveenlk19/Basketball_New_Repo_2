{"file_path": "Source/BasketBallGame/Variant_Combat/AI/CombatStateTreeUtility.cpp", "file_id": "Source_BasketBallGame_Variant_Combat_AI_CombatStateTreeUtility_cpp", "asset_path": "", "doc_id": "qq-8046e6c8-c91e-4825-b10e-fcfe8e1d49b7", "referencers": [], "dependencies": [], "content": "// Copyright Epic Games, Inc. All Rights Reserved.\n\n\n#include \"CombatStateTreeUtility.h\"\n#include \"StateTreeExecutionContext.h\"\n#include \"StateTreeExecutionTypes.h\"\n#include \"GameFramework/Character.h\"\n#include \"GameFramework/CharacterMovementComponent.h\"\n#include \"AIController.h\"\n#include \"CombatEnemy.h\"\n#include \"Kismet/GameplayStatics.h\"\n#include \"StateTreeAsyncExecutionContext.h\"\n\nbool FStateTreeCharacterGroundedCondition::TestCondition(FStateTreeExecutionContext& Context) const\n{\n\tconst FInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t// is the character currently grounded?\n\tbool bCondition = InstanceData.Character->GetMovementComponent()->IsMovingOnGround();\n\n\treturn InstanceData.bMustBeOnAir ? !bCondition : bCondition;\n}\n\n#if WITH_EDITOR\nFText FStateTreeCharacterGroundedCondition::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Is Character Grounded</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeComboAttackTask::EnterState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// bind to the on attack completed delegate\n\t\tInstanceData.Character->OnAttackCompleted.BindLambda(\n\t\t\t[WeakContext = Context.MakeWeakExecutionContext()]()\n\t\t\t{\n\t\t\t\tWeakContext.FinishTask(EStateTreeFinishTaskType::Succeeded);\n\t\t\t}\n\t\t);\n\n\n\t\t// tell the character to do a combo attack\n\t\tInstanceData.Character->DoAIComboAttack();\n\t}\n\n\treturn EStateTreeRunStatus::Running;\n}\n\nvoid FStateTreeComboAttackTask::ExitState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// unbind the on attack completed delegate\n\t\tInstanceData.Character->OnAttackCompleted.Unbind();\n\t}\n}\n\n#if WITH_EDITOR\nFText FStateTreeComboAttackTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Do Combo Attack</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeChargedAttackTask::EnterState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// bind to the on attack completed delegate\n\t\tInstanceData.Character->OnAttackCompleted.BindLambda(\n\t\t\t[WeakContext = Context.MakeWeakExecutionContext()]()\n\t\t\t{\n\t\t\t\tWeakContext.FinishTask(EStateTreeFinishTaskType::Succeeded);\n\t\t\t}\n\t\t);\n\n\t\t// tell the character to do a combo attack\n\t\tInstanceData.Character->DoAIChargedAttack();\n\t}\n\n\treturn EStateTreeRunStatus::Running;\n}\n\nvoid FStateTreeChargedAttackTask::ExitState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// unbind the on attack completed delegate\n\t\tInstanceData.Character->OnAttackCompleted.Unbind();\n\t}\n}\n\n#if WITH_EDITOR\nFText FStateTreeChargedAttackTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Do Charged Attack</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeWaitForLandingTask::EnterState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// bind to the on enemy landed delegate\n\t\tInstanceData.Character->OnEnemyLanded.BindLambda(\n\t\t\t[WeakContext = Context.MakeWeakExecutionContext()]()\n\t\t\t{\n\t\t\t\tWeakContext.FinishTask(EStateTreeFinishTaskType::Succeeded);\n\t\t\t}\n\t\t);\n\t}\n\n\treturn EStateTreeRunStatus::Running;\n}\n\nvoid FStateTreeWaitForLandingTask::ExitState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// bind the on enemy landed delegate\n\t\tInstanceData.Character->OnEnemyLanded.Unbind();\n\t}\n}\n\n#if WITH_EDITOR\nFText FStateTreeWaitForLandingTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Wait for Landing</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeFaceActorTask::EnterState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// set the AI Controller's focus\n\t\tInstanceData.Controller->SetFocus(InstanceData.ActorToFaceTowards);\n\t}\n\n\treturn EStateTreeRunStatus::Running;\n}\n\nvoid FStateTreeFaceActorTask::ExitState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned to another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// clear the AI Controller's focus\n\t\tInstanceData.Controller->ClearFocus(EAIFocusPriority::Gameplay);\n\t}\n}\n\n#if WITH_EDITOR\nFText FStateTreeFaceActorTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Face Towards Actor</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeFaceLocationTask::EnterState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// set the AI Controller's focus\n\t\tInstanceData.Controller->SetFocalPoint(InstanceData.FaceLocation);\n\t}\n\n\treturn EStateTreeRunStatus::Running;\n}\n\nvoid FStateTreeFaceLocationTask::ExitState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned to another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// clear the AI Controller's focus\n\t\tInstanceData.Controller->ClearFocus(EAIFocusPriority::Gameplay);\n\t}\n}\n\n#if WITH_EDITOR\nFText FStateTreeFaceLocationTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Face Towards Location</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeSetCharacterSpeedTask::EnterState(FStateTreeExecutionContext& Context, const FStateTreeTransitionResult& Transition) const\n{\n\t// have we transitioned from another state?\n\tif (Transition.ChangeType == EStateTreeStateChangeType::Changed)\n\t{\n\t\t// get the instance data\n\t\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t\t// set the character's max ground speed\n\t\tInstanceData.Character->GetCharacterMovement()->MaxWalkSpeed = InstanceData.Speed;\n\t}\n\n\treturn EStateTreeRunStatus::Running;\n}\n\n#if WITH_EDITOR\nFText FStateTreeSetCharacterSpeedTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Set Character Speed</b>\");\n}\n#endif // WITH_EDITOR\n\n////////////////////////////////////////////////////////////////////\n\nEStateTreeRunStatus FStateTreeGetPlayerInfoTask::Tick(FStateTreeExecutionContext& Context, const float DeltaTime) const\n{\n\t// get the instance data\n\tFInstanceDataType& InstanceData = Context.GetInstanceData(*this);\n\n\t// get the character possessed by the first local player\n\tInstanceData.TargetPlayerCharacter = Cast<ACharacter>(UGameplayStatics::GetPlayerPawn(InstanceData.Character, 0));\n\n\t// do we have a valid target?\n\tif (InstanceData.TargetPlayerCharacter)\n\t{\n\t\t// update the last known location\n\t\tInstanceData.TargetPlayerLocation = InstanceData.TargetPlayerCharacter->GetActorLocation();\n\t}\n\n\t// update the distance\n\tInstanceData.DistanceToTarget = FVector::Distance(InstanceData.TargetPlayerLocation, InstanceData.Character->GetActorLocation());\n\n\treturn EStateTreeRunStatus::Running;\n}\n\n#if WITH_EDITOR\nFText FStateTreeGetPlayerInfoTask::GetDescription(const FGuid& ID, FStateTreeDataView InstanceDataView, const IStateTreeBindingLookup& BindingLookup, EStateTreeNodeFormatting Formatting /*= EStateTreeNodeFormatting::Text*/) const\n{\n\treturn FText::FromString(\"<b>Get Player Info</b>\");\n}\n#endif // WITH_EDITOR"}