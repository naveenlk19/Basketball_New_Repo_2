{"file_path": "Source/BasketBallGame/BasketBallGameGameMode.cpp", "file_id": "Source_BasketBallGame_BasketBallGameGameMode_cpp", "asset_path": "", "doc_id": "qq-4e7689ee-51b4-42af-a6e3-48f595879939", "referencers": [], "dependencies": [], "content": "// Copyright Epic Games, Inc. All Rights Reserved.\n\n#include \"BasketBallGameGameMode.h\"\n#include \"BasketballScoreManager.h\"\n#include \"BasketBallGameState.h\"\n#include \"TimerManager.h\"\n#include \"Engine/World.h\"\n#include \"Blueprint/UserWidget.h\"\n\nABasketBallGameGameMode::ABasketBallGameGameMode()\n{\n\t// Create score manager component (properly instantiated via CreateDefaultSubobject)\n\tScoreManager = CreateDefaultSubobject<UBasketballScoreManager>(TEXT(\"ScoreManager\"));\n\n\t// Timer defaults\n\tMatchDurationSeconds = 300; // 5 minutes\n\n\t// Set GameState class\n\tGameStateClass = ABasketBallGameState::StaticClass();\n}\n\nvoid ABasketBallGameGameMode::BeginPlay()\n{\n\tSuper::BeginPlay();\n\n\t// Auto-start match on begin play\n\tStartMatch();\n}\n\nvoid ABasketBallGameGameMode::StartMatch()\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS || GS->bMatchActive)\n\t{\n\t\treturn; // Already active\n\t}\n\n\t// Reset state\n\tGS->SetMatchTimeRemaining(MatchDurationSeconds);\n\tGS->SetMatchActive(true);\n\tif (HasAuthority())\n\t{\n\t\tGS->ShotAttempts = 0; // Direct reset\n\t}\n\n\t// Start timer (1 second intervals)\n\tif (UWorld* World = GetWorld())\n\t{\n\t\tWorld->GetTimerManager().SetTimer(\n\t\t\tMatchTimerHandle,\n\t\t\tthis,\n\t\t\t&ABasketBallGameGameMode::UpdateMatchTimer,\n\t\t\t1.0f, // Interval: 1 second\n\t\t\ttrue  // Looping\n\t\t);\n\t}\n\n\t// Broadcast match started\n\tOnMatchStarted.Broadcast();\n\n\t// Broadcast initial timer value\n\tOnMatchTimerUpdated.Broadcast(GS->MatchTimeRemaining);\n\n\tUE_LOG(LogTemp, Log, TEXT(\"BasketBallGameGameMode: Match started - Duration: %d seconds\"), MatchDurationSeconds);\n}\n\nvoid ABasketBallGameGameMode::PauseMatch()\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS || !GS->bMatchActive)\n\t{\n\t\treturn;\n\t}\n\n\tif (UWorld* World = GetWorld())\n\t{\n\t\tWorld->GetTimerManager().PauseTimer(MatchTimerHandle);\n\t}\n\n\tUE_LOG(LogTemp, Log, TEXT(\"BasketBallGameGameMode: Match paused - Remaining: %d seconds\"), GS->MatchTimeRemaining);\n}\n\nvoid ABasketBallGameGameMode::ResumeMatch()\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS || !GS->bMatchActive)\n\t{\n\t\treturn;\n\t}\n\n\tif (UWorld* World = GetWorld())\n\t{\n\t\tWorld->GetTimerManager().UnPauseTimer(MatchTimerHandle);\n\t}\n\n\tUE_LOG(LogTemp, Log, TEXT(\"BasketBallGameGameMode: Match resumed - Remaining: %d seconds\"), GS->MatchTimeRemaining);\n}\n\nvoid ABasketBallGameGameMode::EndMatch()\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS)\n\t{\n\t\treturn;\n\t}\n\n\tGS->SetMatchActive(false);\n\n\t// Clear timer\n\tif (UWorld* World = GetWorld())\n\t{\n\t\tWorld->GetTimerManager().ClearTimer(MatchTimerHandle);\n\t}\n\n\t// Broadcast match ended\n\tOnMatchEnded.Broadcast();\n\n\tUE_LOG(LogTemp, Log, TEXT(\"BasketBallGameGameMode: Match ended - Final Attempts: %d\"), GS->ShotAttempts);\n}\n\nvoid ABasketBallGameGameMode::UpdateMatchTimer()\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS)\n\t{\n\t\treturn;\n\t}\n\n\tint32 NewTime = GS->MatchTimeRemaining - 1;\n\tGS->SetMatchTimeRemaining(NewTime);\n\n\t// Broadcast timer update\n\tOnMatchTimerUpdated.Broadcast(NewTime);\n\n\t// Check if match should end\n\tif (NewTime <= 0)\n\t{\n\t\tEndMatch();\n\t}\n}\n\nvoid ABasketBallGameGameMode::RegisterShotAttempt()\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS)\n\t{\n\t\treturn;\n\t}\n\n\tGS->IncrementShotAttempts();\n\n\t// Broadcast shot attempt update\n\tOnShotAttemptUpdated.Broadcast(GS->ShotAttempts);\n\n\tUE_LOG(LogTemp, Log, TEXT(\"BasketBallGameGameMode: Shot attempt registered - Total: %d\"), GS->ShotAttempts);\n}\n\nvoid ABasketBallGameGameMode::RegisterScore(int32 PointValue)\n{\n\tABasketBallGameState* GS = GetBasketBallGameState();\n\tif (!GS)\n\t{\n\t\treturn;\n\t}\n\n\t// Validate match is active\n\tif (!GS->bMatchActive)\n\t{\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"BasketBallGameGameMode: Score rejected - Match not active\"));\n\t\treturn;\n\t}\n\n\t// Validate point value\n\tif (PointValue <= 0)\n\t{\n\t\tUE_LOG(LogTemp, Warning, TEXT(\"BasketBallGameGameMode: Invalid point value: %d\"), PointValue);\n\t\treturn;\n\t}\n\n\t// Update score through ScoreManager (central data store)\n\tif (ScoreManager)\n\t{\n\t\tScoreManager->AddScore(PointValue);\n\t\t\n\t\t// Broadcast score change event\n\t\tOnScoreChanged.Broadcast(ScoreManager->TotalScore, ScoreManager->TotalMakes, ScoreManager->TotalAttempts);\n\t\t\n\t\tUE_LOG(LogTemp, Display, TEXT(\"BasketBallGameGameMode: Score registered! +%d points. Total: %d | Makes: %d | Attempts: %d\"),\n\t\t\tPointValue, ScoreManager->TotalScore, ScoreManager->TotalMakes, ScoreManager->TotalAttempts);\n\t}\n}\n\nvoid ABasketBallGameGameMode::UpdateHUDTimer(UUserWidget* HUDWidget, int32 Seconds)\n{\n\tif (!HUDWidget)\n\t{\n\t\treturn;\n\t}\n\n\t// Find UpdateTimer function on widget using reflection\n\tUFunction* UpdateTimerFunc = HUDWidget->FindFunction(FName(\"UpdateTimer\"));\n\tif (UpdateTimerFunc)\n\t{\n\t\t// Call with float parameter (converts int to float)\n\t\tstruct FUpdateTimerParams\n\t\t{\n\t\t\tfloat RemainingTime;\n\t\t};\n\t\tFUpdateTimerParams Params{static_cast<float>(Seconds)};\n\t\tHUDWidget->ProcessEvent(UpdateTimerFunc, &Params);\n\t}\n}\n\nABasketBallGameState* ABasketBallGameGameMode::GetBasketBallGameState() const\n{\n\treturn GetGameState<ABasketBallGameState>();\n}\n"}